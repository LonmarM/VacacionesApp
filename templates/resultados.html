<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% if is_admin %}Panel de Administración{% else %}Solicitud de Vacaciones{% endif %} | Gestión Corporativa</title>

    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css' rel='stylesheet' />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            font-family: "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background: #f5f5f5;
        }

        header {
            background: #1f2937;
            color: white;
            padding: 20px;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
        }

        .container {
            max-width: 1200px;
            margin: 40px auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 18px rgba(0,0,0,0.15);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 40px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f3f4f6;
            color: #1f2937;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
        }
        
        .status-Pending { background-color: #fef3c7; color: #a16207; padding: 4px; border-radius: 4px; font-weight: bold;}
        .status-Approved { background-color: #d1fae5; color: #065f46; padding: 4px; border-radius: 4px; font-weight: bold;}
        .status-Rejected { background-color: #fee2e2; color: #991b1b; padding: 4px; border-radius: 4px; font-weight: bold;}
        .status-NA, .status-Sin { background-color: #e5e7eb; color: #374151; padding: 4px; border-radius: 4px; font-weight: bold;}
    </style>
</head>
<body>

<header>
    Gestión de Vacaciones
</header>

<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{% if is_admin %}Panel de Aprobación{% else %}Solicitud de Empleados{% endif %}</h2>
        <div class="actions">
            {% if is_admin %}
                <a href="{{ url_for('employee_request_form') }}" class="btn btn-secondary">Vista de Solicitud</a>
                <a href="{{ url_for('descargar_pdf') }}" class="btn btn-primary">Descargar Aprobadas (PDF)</a>
            {% else %}
                <a href="{{ url_for('admin_view') }}" class="btn btn-secondary">Vista de Administración</a>
            {% endif %}
        </div>
    </div>

    {% if message %}
        <div class="alert alert-info" role="alert">{{ message }}</div>
    {% endif %}
    

    {% if results_type == 'request' %}
        
        <h3>Resumen de Empleados y Última Solicitud</h3>
        <div class="mb-3 position-relative" style="max-width: 350px;">
        <input type="text" id="searchInput" class="form-control" placeholder="Buscar empleado...">
        <div id="suggestions" 
            style="position:absolute; top:100%; left:0; width:100%; background:white; 
                    border:1px solid #ccc; border-top:none; z-index:10; display:none;
                    max-height:200px; overflow-y:auto;">
            </div>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Empleado</th>
                    <th>Área</th>
                    <th>Días generados</th>
                    <th>Días tomados</th>
                    <th>Días disponibles</th>
                    <th>Inicio Vacaciones</th>
                    <th>Fin Vacaciones</th>
                    <th>Estado</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody>
                {% for r in data %}
                <tr>
                    <td>{{ r.nombre }}</td>
                    <td>{{ r.area }}</td>
                    <td>{{ r.dias_generados }}</td>
                    <td>{{ r.dias_tomados }}</td>
                    <td>{{ r.dias_disponibles }}</td>
                    <td>{{ r.inicio_vacaciones }}</td>
                    <td>{{ r.fin_vacaciones }}</td>
                    <td>
                        <span class="status-{{ r.estado | replace(' ', '-') }}">
                            {% if r.estado == "Pending" %}Pendiente
                            {% elif r.estado == "Approved" or r.estado == "Aprobado" %}Aprobada
                            {% elif r.estado == "Rejected" or r.estado == "Denegado" %}Denegada
                            {% else %}N/A
                            {% endif %}
                        </span>
                    </td>

                    <td>
                        <button class="btn btn-success btn-sm" onclick="openRequestModal('{{ r.nombre }}')">
                            Solicitar
                        </button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

    {% elif results_type == 'admin' %}
        <h3>Lista de Solicitudes (Todas)</h3>
        <table>
            <thead>
                <tr>
                    <th>Empleado</th>
                    <th>Área</th>
                    <th>Días Solicitados</th>
                    <th>Inicio</th>
                    <th>Fin</th>
                    <th>Fecha Solicitud</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for r in data %}
                <tr>
                    <td>{{ r.nombre }}</td>
                    <td>{{ r.area }}</td>
                    <td>{{ r.dias }}</td>
                    <td>{{ r.inicio }}</td>
                    <td>{{ r.fin }}</td>
                    <td>{{ r.solicitado_en.split('T')[0] if r.solicitado_en else 'N/A' }}</td>
                    <td>
                        <span class="status-{{ r.estado | replace(' ', '-') }}">
                            {% if r.estado == "Pending" %}Pendiente
                            {% elif r.estado == "Approved" or r.estado == "Aprobado" %}Aprobada
                            {% elif r.estado == "Rejected" or r.estado == "Denegado" %}Denegada
                            {% else %}N/A
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        {% if r.estado == 'Pending' %}
                            <form action="{{ url_for('action_request') }}" method="POST" style="display:inline;">
                                <input type="hidden" name="nombre" value="{{ r.nombre }}">
                                <input type="hidden" name="inicio" value="{{ r.inicio }}">
                                <button type="submit" name="action" value="Aprobado" class="btn btn-primary btn-sm">Aprobar</button>
                            </form>
                            <form action="{{ url_for('action_request') }}" method="POST" style="display:inline;">
                                <input type="hidden" name="nombre" value="{{ r.nombre }}">
                                <input type="hidden" name="inicio" value="{{ r.inicio }}">
                                <button type="submit" name="action" value="Denegado" class="btn btn-danger btn-sm">Denegar</button>
                            </form>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% endif %}

    <h2 class="mt-5">Calendario de Vacaciones</h2>
    <div id="calendar"></div>

</div>

<!-- MODAL SIMPLIFICADO (SOLO FECHA INICIO) -->
<div id="requestModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000;">
    <div style="background:white; width:400px; margin:100px auto; padding:20px; border-radius:8px;">
        <h3>Solicitar Vacaciones</h3>
        
        <form id="vacacionesForm" action="/submit" method="POST">
            <input type="hidden" name="nombre_solicitud" id="nombre_solicitud_input">

            <label class="form-label">Fecha de Inicio:</label>
            <input type="date" name="inicio_fecha" class="form-control mb-3" required>

            <button type="submit" class="btn btn-success w-100">Enviar Solicitud</button>
            <button type="button" class="btn btn-secondary w-100 mt-2" onclick="closeRequestModal()">Cancelar</button>
        </form>
    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js'></script>
<script>

function openRequestModal(nombre) {
    document.getElementById('nombre_solicitud_input').value = nombre;
    document.getElementById('requestModal').style.display = 'block';
}

function closeRequestModal() {
    document.getElementById('requestModal').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');

    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        height: "auto",
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,listWeek'
        },
        events: {{ eventos|safe }}
    });

    calendar.render();
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const searchInput = document.getElementById("searchInput");
    const suggestionsBox = document.getElementById("suggestions");

    // Capturar lista de nombres desde la tabla
    let empleados = Array.from(document.querySelectorAll("tbody tr td:first-child"))
                         .map(td => td.textContent.trim());

    function filtrarTabla(filtro) {
        filtro = filtro.toLowerCase();
        document.querySelectorAll("tbody tr").forEach(row => {
            let nombre = row.children[0].textContent.toLowerCase();
            row.style.display = nombre.includes(filtro) ? "" : "none";
        });
    }

    function mostrarSugerencias(texto) {
        let filtradas = empleados.filter(e => e.toLowerCase().includes(texto.toLowerCase()));
        if (filtradas.length === 0 || texto.trim() === "") {
            suggestionsBox.style.display = "none";
            return;
        }

        suggestionsBox.innerHTML = filtradas
            .map(e => `<div class="p-2 suggestion-item" style="cursor:pointer;">${e}</div>`)
            .join("");

        suggestionsBox.style.display = "block";

        document.querySelectorAll(".suggestion-item").forEach(item => {
            item.addEventListener("click", function () {
                searchInput.value = this.textContent;
                suggestionsBox.style.display = "none";
                filtrarTabla(this.textContent);
            });
        });
    }

    searchInput.addEventListener("input", function () {
        let texto = this.value;
        mostrarSugerencias(texto);
        filtrarTabla(texto);
    });

    document.addEventListener("click", function (e) {
        if (!suggestionsBox.contains(e.target) && e.target !== searchInput) {
            suggestionsBox.style.display = "none";
        }
    });
});
</script>
<script>
document.getElementById("vacacionesForm").addEventListener("submit", function(event) {
    event.preventDefault(); // Evita envío automático

    const formData = new FormData(this);

    fetch("/calcular_disponibilidad", {
        method: "POST",
        body: formData
    })
    .then(response => response.json())
    .then(data => {

        console.log("Respuesta:", data); // Para ver qué llega

        if (!data.permitido) {
            alert(data.mensaje);  // 
            return;              // 
        }

        // Si está permitido → enviar
        this.submit();
    })
    .catch(err => {
        console.error(err);
        alert("Error al validar la solicitud.");
    });
});
</script>


</body>
</html>
